<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AME: Extensions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AME<span id="projectnumber">&#160;v0.0.8</span>
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_build__deps_doctest_src_doc_markdown_extensions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Extensions </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The doctest header doesn't include any external or stdlib headers in it's interface part in order to provide the most optimal build times but that means it is limited in what it can provide as functionality =&gt; that's when extensions come into play. They are located as header files in <a href="../../doctest/extensions"><code>doctest/extensions</code></a> and each of them is documented in a section here.</p>
<h1><a class="anchor" id="autotoc_md104"></a>
&lt;a href="../../doctest/extensions/doctest_util.h" &gt;Utils&lt;/a&gt;</h1>
<p >nothing here yet...</p>
<h1><a class="anchor" id="autotoc_md105"></a>
&lt;a href="../../doctest/extensions/doctest_mpi.h" &gt;Distributed tests with MPI&lt;/a&gt;</h1>
<p >[Bruno Maugars and BÃ©renger Berthoul, ONERA]</p>
<p >Testing code over distributed processes requires support from the testing framework. <b>Doctest</b> support for MPI parallel communication is provided in the <code>"doctest/extensions/doctest_mpi.h"</code> header.</p>
<h2><a class="anchor" id="autotoc_md106"></a>
Example</h2>
<p >See <a href="../../examples/mpi/mpi.cpp"><b>the complete test</b></a> and <a href="../../examples/mpi/main.cpp"><b>the configuration of main()</b></a></p>
<h3><a class="anchor" id="autotoc_md107"></a>
MPI_TEST_CASE</h3>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &quot;doctest/extensions/doctest_mpi.h&quot;</div>
<div class="line"> </div>
<div class="line">int my_function_to_test(MPI_Comm comm) {</div>
<div class="line">  int rank;</div>
<div class="line">  MPI_comm_rank(comm,&amp;rank);</div>
<div class="line">  if (rank == 0) {</div>
<div class="line">    return 10;</div>
<div class="line">  }</div>
<div class="line">  return 11;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">MPI_TEST_CASE(&quot;test over two processes&quot;,2) { // Parallel test on 2 processes</div>
<div class="line">  int x = my_function_to_test(test_comm);</div>
<div class="line">  </div>
<div class="line">  MPI_CHECK( 0,  x==10 ); // CHECK for rank 0, that x==10</div>
<div class="line">  MPI_CHECK( 1,  x==11 ); // CHECK for rank 1, that x==11</div>
<div class="line">}</div>
</div><!-- fragment --><p >An <code>MPI_TEST_CASE</code> is like a regular <code>TEST_CASE</code>, except it takes a second argument, which is the number of processes needed to run the test. If the number of processes is less than 2, the test will fail. If the number of processes is greater than or equal to 2, it will create a sub-communicator over 2 processes, called <code>test_comm</code>, and execute the test over these processes. Three objects are provided by <code>MPI_TEST_CASE</code>:</p><ul>
<li><code>test_comm</code>, of type <code>MPI_Comm</code>: the mpi communicator on which the test is running,</li>
<li><code>test_rank</code> and <code>test_nb_procs</code>, two <code>int</code> giving respectively the rank of the current process and the size of the communicator for <code>test_comm</code>. These last two are just here for convenience and could be retrived from <code>test_comm</code>.</li>
</ul>
<p >We always have:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">MPI_TEST_CASE(&quot;my_test&quot;,N) {</div>
<div class="line">  CHECK( test_nb_procs == N );</div>
<div class="line">  MPI_CHECK( i, test_rank==i ); // for any i&lt;N</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md108"></a>
Assertions</h3>
<p >It is possible to use regular assertions in an <code>MPI_TEST_CASE</code>. MPI-specific assertions are also provided and are all prefixed with <code>MPI_</code> (<code>MPI_CHECK</code>, <code>MPI_ASSERT</code>...). The first argument is the rank for which they are checked, and the second is the usual expression to check.</p>
<h2><a class="anchor" id="autotoc_md109"></a>
The main entry points and mpi reporters</h2>
<p >You need to launch the unit tests with an <code>mpirun</code> command: </p><div class="fragment"><div class="line">mpirun -np 2 unit_test_executable.exe</div>
</div><!-- fragment --><div class="fragment"><div class="line"> {MPI_Init```}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">```c++</div>
<div class="line">#define DOCTEST_CONFIG_IMPLEMENT</div>
<div class="line"> </div>
<div class="line">#include &quot;doctest/mpi/doctest.h&quot;</div>
<div class="line"> </div>
<div class="line">int main(int argc, char** argv) {</div>
<div class="line">  MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line"> </div>
<div class="line">  doctest::Context ctx;</div>
<div class="line">  ctx.setOption(&quot;reporters&quot;, &quot;MpiConsoleReporter&quot;);</div>
<div class="line">  ctx.setOption(&quot;reporters&quot;, &quot;MpiFileReporter&quot;);</div>
<div class="line">  ctx.setOption(&quot;force-colors&quot;, true);</div>
<div class="line">  ctx.applyCommandLine(argc, argv);</div>
<div class="line"> </div>
<div class="line">  int test_result = ctx.run();</div>
<div class="line"> </div>
<div class="line">  MPI_Finalize();</div>
<div class="line"> </div>
<div class="line">  return test_result;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md110"></a>
MpiConsoleReporter</h3>
<p >The <code>MpiConsoleReporter</code> should be substituted to the default reporter. It does the same as the default console reporter for regular assertions, but only outputs on process 0. For MPI test cases, if there is a failure it tells the process that failed</p>
<div class="fragment"><div class="line">[doctest] doctest version is &quot;2.4.0&quot;</div>
<div class="line">[doctest] run with &quot;--help&quot; for options</div>
<div class="line">===============================================================================</div>
<div class="line">[doctest] test cases:    171 |    171 passed |      0 failed |      0 skipped</div>
<div class="line">[doctest] assertions:    864 |    864 passed |      0 failed |</div>
<div class="line">[doctest] Status: SUCCESS!</div>
<div class="line">std_e_mpi_unit_tests</div>
<div class="line">[doctest] doctest version is &quot;2.4.0&quot;</div>
<div class="line">[doctest] run with &quot;--help&quot; for options</div>
<div class="line">===============================================================================</div>
<div class="line">path/to/test.cpp:30:</div>
<div class="line">TEST CASE: my test case </div>
<div class="line"> </div>
<div class="line">On rank [2] : path/to/test.cpp:35: CHECK( x==-1 ) is NOT correct!</div>
<div class="line">  values: CHECK( 0 == -1 )</div>
<div class="line"> </div>
<div class="line">===============================================================================</div>
<div class="line">[doctest] test cases:      2 |      2 passed |      0 failed |      0 skipped</div>
<div class="line">[doctest] assertions:      2 |      2 passed |      0 failed |</div>
<div class="line">[doctest] Status: SUCCESS!</div>
<div class="line">===============================================================================</div>
<div class="line">[doctest] glob assertions:      5 |      4 passed |      1 failed |</div>
<div class="line">===============================================================================</div>
<div class="line">[doctest] fail on rank:     </div>
<div class="line">    -&gt; On rank [2] with 1 test failed</div>
<div class="line">[doctest] Status: FAILURE!</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md111"></a>
MpiFileReporter</h3>
<p >The <code>MpiFileReporter</code> will just print the result of each process in its own file, named <code>doctest_[rank].log</code>. Only use this reporter as a debug facility if you want to know what is going on exactly when a parallel test case is failing.</p>
<h3><a class="anchor" id="autotoc_md112"></a>
Other reporters</h3>
<p >Other reporters (jUnit, XML) are not supported directly, which mean that you can always print the result of each process to its own file, but there is (currently) no equivalent of the <code>MpiConsoleReporter</code> that will aggregate the results of all processes.</p>
<h2><a class="anchor" id="autotoc_md113"></a>
Note</h2>
<p >This feature is provided to unit-test mpi-distributed code. It is <b>not</b> a way to parallelize many unit tests over several processes (for that, see <a href="../../examples/range_based_execution.py"><b>the example python script</b></a>).</p>
<h2><a class="anchor" id="autotoc_md114"></a>
TODO</h2>
<ul>
<li>Pass <code>s</code> member variable of <code>ConsoleReporter</code> as an argument to member functions so we can use them with another object (would help to factorize <code>MPIConsoleReporter</code>)</li>
<li>Only MPI_CHECK tested. MPI_REQUIRE, exception handling: nothing tested</li>
<li>If the number of processes is not enought, prints the correct message, but then deadlocks (comes from <code>MPI_Probe</code> in <code>MpiConsoleReporter</code>)</li>
<li>[[maybe_unused]] is C++17</li>
<li>More testing, automatic testing</li>
<li>Packaging: create a new target <code>mpi_doctest</code>? (probably cleaner to depend explicitly on MPI for mpi/doctest.h)</li>
<li>Later, maybe: have a general mechanism to represent assertions so we can separate the report format (console, xml, junit...) from the reporting strategy (sequential vs. MPI)</li>
</ul>
<hr  />
<p ><a href="readme.md#reference">Home</a></p>
<p ><img src="../../scripts/data/logo/icon_2.svg" alt="" style="pointer-events: none;" class="inline"/></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
